<html>
<head>
	<title>Catacomb 3-D Test</title>
	<link rel="icon" type="image/png" href="favicon.png"/>
	<style>
		body { margin: 0; }
		#cat3d { width: 100%; height: 100%; overflow: hidden; }
	</style>
</head>
<body>
	<div id="cat3d"></div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r83/three.js" crossorigin="anonymous"></script>
<script id="vertex" type="text/plain">
#include <common>
#include <uv_pars_vertex>

void main() {
	#include <uv_vertex>
	#include <begin_vertex>
	#include <project_vertex>
}
</script>
<script id="fragment" type="text/plain">
uniform vec3 diffuse;
uniform float opacity;

#include <common>
#include <uv_pars_fragment>

void main() {

	vec4 diffuseColor = vec4(diffuse, opacity);

	#include <map_fragment>

	ReflectedLight reflectedLight = ReflectedLight(vec3(0.0), vec3(0.0), vec3(1.0), vec3(0.0));
	reflectedLight.indirectDiffuse *= diffuseColor.rgb;
	vec3 outgoingLight = reflectedLight.indirectDiffuse;
	gl_FragColor = vec4(outgoingLight, diffuseColor.a);
}
</script>
<script>
"use strict";

const gameContainer = document.getElementById("cat3d")

const renderer = new THREE.WebGLRenderer({antialias: true})
gameContainer.appendChild(renderer.domElement)

const camera = new THREE.PerspectiveCamera(45, 0, 0.01, 256)
const clock = new THREE.Clock()
const scene = new THREE.Scene()

function resizeView(width, height) {
	renderer.setSize(width, height)
	camera.aspect = width / height
	camera.updateProjectionMatrix()
}

resizeView(gameContainer.clientWidth, gameContainer.clientHeight)

let resizeNextFrame = false
window.addEventListener("resize", () => {
	if (!resizeNextFrame) {
		window.requestAnimationFrame(() => {
			resizeView(gameContainer.clientWidth, gameContainer.clientHeight)
			resizeNextFrame = false
		})
		resizeNextFrame = true
	}
})

function render() {
	const time = clock.getElapsedTime()
	const objectsToRemove = []
	scene.traverse(obj => {
		obj.update && obj.update(time)
		if (obj.shouldRemove) {
			objectsToRemove.push(obj)
		}
	})
	objectsToRemove.forEach(obj => obj.parent.remove(obj))
	renderer.render(scene, camera)
	requestAnimationFrame(render)
}

const material = new THREE.ShaderMaterial({
	vertexShader: document.getElementById("vertex").textContent,
	fragmentShader: document.getElementById("fragment").textContent,
	uniforms: THREE.UniformsLib.common
})
const box = new THREE.Mesh(new THREE.BoxBufferGeometry(1, 1, 1), material)
box.position.z = -3
scene.add(box)
render()
</script>
</html>
